{"createdAt":"2025-06-12T18:20:21.977Z","updatedAt":"2025-06-25T21:32:49.000Z","id":"nBpssYJ8QFQzQayQ","name":"Car work","active":false,"isArchived":false,"nodes":[{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"leftValue":"={{ $json.message.photo }}","rightValue":"","operator":{"type":"array","operation":"exists","singleValue":true},"id":"18078eae-2e01-4cb7-832d-9ffbd29c8917"}],"combinator":"and"},"renameOutput":true,"outputKey":"hasImage"}]},"options":{}},"id":"1029a167-14a5-41b4-901d-c2221aa97f3d","name":"Check if Image","type":"n8n-nodes-base.switch","typeVersion":3,"position":[-520,660],"notesInFlow":false,"onError":"continueErrorOutput"},{"parameters":{"assignments":{"assignments":[{"id":"prompt-assignment","name":"prompt","value":"Analyze this car dashboard image and extract the odometer/kilometer reading. Look for:\n\n1. Digital or analog odometer display\n2. Total distance/mileage counter\n3. Any numbers indicating kilometers driven\n4. Trip meter readings\n\nProvide the exact number of kilometers shown on the odometer. If you can see multiple readings (like trip A, trip B, total), focus on the TOTAL odometer reading.\n\nRespond with the kilometer reading in this format:\nOdometer: [NUMBER] km\n\nIf you cannot clearly read the odometer, explain what you can see and why the reading is unclear.","type":"string"}]},"options":{}},"id":"924058ca-6b31-4f2a-b5dd-919ca7949237","name":"Set OCR Prompt","type":"n8n-nodes-base.set","typeVersion":3.3,"position":[-240,580]},{"parameters":{"chatId":"={{ $json.message.chat.id }}","text":"Please send an image of your car's dashboard showing the odometer/kilometer reading. 📸🚗","additionalFields":{"appendAttribution":false}},"id":"a01c1aaa-71c5-40e1-9579-ad8dc1143a29","name":"Request Image","type":"n8n-nodes-base.telegram","typeVersion":1.1,"position":[-240,760],"webhookId":"8e1a7a7b-6218-4d9a-92be-2a3597e5d53b"},{"parameters":{"content":"## Car Odometer OCR Workflow (Chat ID Restricted)\n\nThis workflow:\n1. **Receives images** from Telegram\n2. **Checks** if message is from authorized chat ID\n3. **Validates** if message contains an image\n4. **Analyzes** the image using OpenAI Vision\n5. **Extracts** kilometer readings using OCR\n6. **Sends results** back to the same Telegram group\n\n### Setup Required:\n- Telegram Bot Token\n- OpenAI API Key with Vision model access\n- **Update Chat ID** in \"Check Chat ID\" node\n\n### Security:\n- Only processes messages from specified chat ID\n- Unauthorized chats are ignored silently","height":490,"width":400,"color":7},"id":"1b9e31fa-3024-4f05-b59c-48b8dfde542a","name":"Workflow Info","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-720,120]},{"parameters":{"content":"## Chat ID Configuration\n\n**IMPORTANT:** Update the Chat ID in the \"Check Chat ID\" node!\n\n1. Replace `-1001234567890` with your actual chat ID\n2. To get your chat ID:\n   - Add the bot to your group\n   - Send a message\n   - Check bot logs or use @userinfobot\n   - Group IDs start with `-100`\n   - Private chats have positive numbers\n\n**Security:** Messages from other chats are silently ignored.","height":350,"width":390,"color":4},"id":"351bf1fb-edc4-4dc2-805c-d5d9943ed794","name":"Chat ID Setup","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-720,840]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Extract kilometers from OCR analysis\nconst analysis = $input.item.json.content || $input.item.json.text || '';\n\n// Common patterns for odometer readings\nconst patterns = [\n  /(?:odometer|odo|mileage|km|kilometers?)\\s*:?\\s*([0-9,\\.\\s]+)\\s*(?:km|kilometers?)?/i,\n  /([0-9]{1,3}(?:[,\\.]?[0-9]{3})*(?:\\.[0-9]+)?)\\s*(?:km|kilometers?)/i,\n  /total\\s*(?:distance|km|kilometers?)\\s*:?\\s*([0-9,\\.\\s]+)/i,\n  /([0-9]{3,6})\\s*(?:km|kilometers?)/i\n];\n\nlet extractedKm = null;\nlet confidence = 'low';\n\n// Try each pattern\nfor (const pattern of patterns) {\n  const match = analysis.match(pattern);\n  if (match) {\n    let kmValue = match[1].replace(/[,\\s]/g, '').replace(/\\.$/, '');\n    const numValue = parseFloat(kmValue);\n    \n    // Validate reasonable odometer reading (between 0 and 999,999 km)\n    if (!isNaN(numValue) && numValue >= 0 && numValue <= 999999) {\n      extractedKm = Math.round(numValue);\n      confidence = 'high';\n      break;\n    }\n  }\n}\n\n// Fallback: extract any number that looks like an odometer reading\nif (!extractedKm) {\n  const numbers = analysis.match(/\\b([0-9]{4,6})\\b/g);\n  if (numbers) {\n    for (const num of numbers) {\n      const value = parseInt(num);\n      if (value >= 1000 && value <= 999999) {\n        extractedKm = value;\n        confidence = 'medium';\n        break;\n      }\n    }\n  }\n}\n\nreturn {\n  originalAnalysis: analysis,\n  extractedKilometers: extractedKm,\n  confidence: confidence,\n  chatId: $input.item.json.message?.chat?.id,\n  messageId: $input.item.json.message?.message_id,\n  formattedKm: extractedKm ? extractedKm.toLocaleString() : null\n};"},"id":"9b96b603-16dd-4a1d-ac4f-1cf423cddc96","name":"Extract Kilometers","type":"n8n-nodes-base.code","typeVersion":2,"position":[640,580]},{"parameters":{"chatId":"={{ $json.chatId }}","text":"={{ $json.extractedKilometers ? `🚗 Car Odometer Reading Detected!\\n\\n📊 **Kilometers:** ${$json.formattedKm} km\\n🎯 **Confidence:** ${$json.confidence}\\n\\n${$json.confidence === 'low' ? '⚠️ Low confidence reading - please verify the number manually.' : '✅ Reading extracted successfully!'}` : '❌ Could not detect odometer reading in the image.\\n\\nPlease ensure the image shows a clear view of the car dashboard with visible kilometer reading.' }}","additionalFields":{"appendAttribution":false}},"id":"420ffe2d-060f-4ee9-ae35-180ae7aa857f","name":"Send OCR Result","type":"n8n-nodes-base.telegram","typeVersion":1.1,"position":[840,580],"webhookId":"756176fd-90e2-4135-a87a-778a1fc4af8e"},{"parameters":{"model":"meta-llama/llama-4-scout-17b-16e-instruct","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGroq","typeVersion":1,"position":[80,800],"id":"675bf4a5-2adb-4970-aef8-5bd2c6041b4b","name":"Groq Chat Model"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2,"position":[160,580],"id":"c8cc96db-eb0f-4698-a368-7c61a00cc39b","name":"AI Agent"},{"parameters":{},"type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","typeVersion":1.3,"position":[260,800],"id":"90250465-d4de-498d-b205-32d2e411988a","name":"Simple Memory"},{"parameters":{"updates":["message"],"additionalFields":{"chatIds":"-1002371463174"}},"type":"n8n-nodes-base.telegramTrigger","typeVersion":1.2,"position":[-720,660],"id":"5458d0dd-2586-4bba-bb73-5e9bbb20e76d","name":"Gas group","webhookId":"4ad0ba1a-3692-4ead-93e0-bd538f1851a0"},{"parameters":{"jsCode":"const message = $input.first().json.message;\n\nif (message.photo) {\n  if (Array.isArray(message.photo)) {\n    // Multiple photos\n    return message.photo.map(photoObj => ({\n      json: {\n        file_id: photoObj.file_id,\n        width: photoObj.width,\n        height: photoObj.height\n      }\n    }));\n  } else {\n    // Single photo object (not an array)\n    return [{\n      json: {\n        file_id: message.photo.file_id,\n        width: message.photo.width,\n        height: message.photo.height\n      }\n    }];\n  }\n} else {\n  // No photos found\n  return [];\n}\n"},"id":"d74308aa-cc00-42f4-8f05-a219575bef36","name":"Extract Photo file_ids1","type":"n8n-nodes-base.code","typeVersion":1,"position":[80,280]},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ Array.isArray($json) }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true},"id":"37b8fcc1-f961-4e50-820b-ae086b55e11a"}],"combinator":"and"},"renameOutput":true,"outputKey":"array"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[300,280],"id":"74a89ba3-e54a-4f77-8274-aa4ae07f380f","name":"Switch"},{"parameters":{"updates":["message"],"additionalFields":{"chatIds":"-1002371463174"}},"type":"n8n-nodes-base.telegramTrigger","typeVersion":1.2,"position":[-260,-80],"id":"f219d496-0985-4dc6-acbc-7ebff43e1e24","name":"no photo","webhookId":"4ad0ba1a-3692-4ead-93e0-bd538f1851a0"},{"parameters":{"updates":["message"],"additionalFields":{"chatIds":"-1002371463174"}},"type":"n8n-nodes-base.telegramTrigger","typeVersion":1.2,"position":[-260,260],"id":"76995e8a-e698-4348-b43d-343c8f69d5eb","name":"no photo1","webhookId":"4ad0ba1a-3692-4ead-93e0-bd538f1851a0"},{"parameters":{"updates":["message"],"additionalFields":{"chatIds":"-1002371463174"}},"type":"n8n-nodes-base.telegramTrigger","typeVersion":1.2,"position":[-260,80],"id":"cbdfb4c2-2996-4439-b83d-b53d2b39675a","name":"4 photo","webhookId":"4ad0ba1a-3692-4ead-93e0-bd538f1851a0"}],"connections":{"Check if Image":{"main":[[{"node":"Set OCR Prompt","type":"main","index":0}],[{"node":"Request Image","type":"main","index":0}]]},"Set OCR Prompt":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"Extract Kilometers":{"main":[[{"node":"Send OCR Result","type":"main","index":0}]]},"Groq Chat Model":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"AI Agent":{"main":[[{"node":"Extract Kilometers","type":"main","index":0}]]},"Simple Memory":{"ai_memory":[[{"node":"AI Agent","type":"ai_memory","index":0}]]},"Gas group":{"main":[[{"node":"Extract Photo file_ids1","type":"main","index":0}]]},"Extract Photo file_ids1":{"main":[[{"node":"Switch","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{"Gas group":[{"json":{"update_id":778130064,"message":{"message_id":4,"from":{"id":628771922,"is_bot":false,"first_name":"Eduardo","username":"eddardstark67","language_code":"pt-pt"},"chat":{"id":-1002371463174,"title":"GAS","type":"supergroup"},"date":1749141624,"photo":[{"file_id":"AgACAgQAAyEFAASNWagGAAMEaEHIeKyKNJfTjjFbxRW74-WI5JwAAsTLMRtGoBBSAAH4oShXd9FjAQADAgADcwADNgQ","file_unique_id":"AQADxMsxG0agEFJ4","file_size":1053,"width":51,"height":90},{"file_id":"AgACAgQAAyEFAASNWagGAAMEaEHIeKyKNJfTjjFbxRW74-WI5JwAAsTLMRtGoBBSAAH4oShXd9FjAQADAgADbQADNgQ","file_unique_id":"AQADxMsxG0agEFJy","file_size":13745,"width":180,"height":320},{"file_id":"AgACAgQAAyEFAASNWagGAAMEaEHIeKyKNJfTjjFbxRW74-WI5JwAAsTLMRtGoBBSAAH4oShXd9FjAQADAgADeAADNgQ","file_unique_id":"AQADxMsxG0agEFJ9","file_size":62798,"width":451,"height":800},{"file_id":"AgACAgQAAyEFAASNWagGAAMEaEHIeKyKNJfTjjFbxRW74-WI5JwAAsTLMRtGoBBSAAH4oShXd9FjAQADAgADeQADNgQ","file_unique_id":"AQADxMsxG0agEFJ-","file_size":117007,"width":721,"height":1280}]}}}],"no photo":[{"json":{"update_id":778130068,"message":{"message_id":7,"from":{"id":628771922,"is_bot":false,"first_name":"Eduardo","username":"eddardstark67","language_code":"pt-pt"},"chat":{"id":-1002371463174,"title":"🚗 Gas","type":"supergroup"},"date":1749197533,"new_chat_title":"🚗 Gas"}}}],"4 photo":[{"json":{"update_id":778130064,"message":{"message_id":4,"from":{"id":628771922,"is_bot":false,"first_name":"Eduardo","username":"eddardstark67","language_code":"pt-pt"},"chat":{"id":-1002371463174,"title":"GAS","type":"supergroup"},"date":1749141624,"photo":[{"file_id":"AgACAgQAAyEFAASNWagGAAMEaEHIeKyKNJfTjjFbxRW74-WI5JwAAsTLMRtGoBBSAAH4oShXd9FjAQADAgADcwADNgQ","file_unique_id":"AQADxMsxG0agEFJ4","file_size":1053,"width":51,"height":90},{"file_id":"AgACAgQAAyEFAASNWagGAAMEaEHIeKyKNJfTjjFbxRW74-WI5JwAAsTLMRtGoBBSAAH4oShXd9FjAQADAgADbQADNgQ","file_unique_id":"AQADxMsxG0agEFJy","file_size":13745,"width":180,"height":320},{"file_id":"AgACAgQAAyEFAASNWagGAAMEaEHIeKyKNJfTjjFbxRW74-WI5JwAAsTLMRtGoBBSAAH4oShXd9FjAQADAgADeAADNgQ","file_unique_id":"AQADxMsxG0agEFJ9","file_size":62798,"width":451,"height":800},{"file_id":"AgACAgQAAyEFAASNWagGAAMEaEHIeKyKNJfTjjFbxRW74-WI5JwAAsTLMRtGoBBSAAH4oShXd9FjAQADAgADeQADNgQ","file_unique_id":"AQADxMsxG0agEFJ-","file_size":117007,"width":721,"height":1280}]}}}]},"versionId":"98febc36-2e6a-40bf-8023-e753eaf8b9ea","triggerCount":0,"shared":[{"createdAt":"2025-06-12T18:20:21.995Z","updatedAt":"2025-06-12T18:20:21.995Z","role":"workflow:owner","workflowId":"nBpssYJ8QFQzQayQ","projectId":"uOq34c8HjhQfCJ55"}],"tags":[]}